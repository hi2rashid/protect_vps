#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

# === SPINNER ===
spin() {
  local pid=$!
  local delay=0.1
  local spinstr='|/-\'
  while kill -0 "$pid" 2>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  wait $pid
}

log() {
  echo -e "\n[$(date +"%H:%M:%S")] $1"
}

# === NETWORK & SECURITY CHECK FUNCTION ===
check_network_security() {
  echo -e "\n🔍 Starting network & security checks..."

  echo -e "\n1️⃣ Active network connections (ss):"
  sudo ss -tupn | head -n 20

  echo -e "\n2️⃣ Suspicious port scanner processes:"
  pscan=$(ps aux | grep -Ei 'nmap|masscan|scan|portscan|zmap' | grep -v grep || true)
  if [[ -z "$pscan" ]]; then
    echo "✅ No common port scanner processes detected."
  else
    echo "⚠️ Possible port scanner processes found:"
    echo "$pscan"
  fi

  echo -e "\n3️⃣ Fail2Ban SSH ban status (if fail2ban installed):"
  if command -v fail2ban-client &>/dev/null; then
    sudo fail2ban-client status sshd || echo "No SSH jail found."
  else
    echo "⚠️ fail2ban not installed."
  fi

  echo -e "\n4️⃣ Recent SSH login attempts (last 20 lines):"
  sudo tail -n 20 /var/log/auth.log | grep -i ssh || echo "No recent ssh logins found or log missing."

  echo -e "\n5️⃣ Current UFW firewall status:"
  if command -v ufw &>/dev/null; then
    sudo ufw status verbose
  else
    echo "⚠️ UFW firewall not installed."
  fi

  echo -e "\n6️⃣ Top remote IPs by current connections:"
  if command -v conntrack &>/dev/null; then
    sudo conntrack -L 2>/dev/null | awk '{print $5}' | sort | uniq -c | sort -nr | head -n 10
  else
    echo "⚠️ conntrack not installed."
  fi

  echo -e "\n7️⃣ Listening ports summary:"
  sudo ss -tuln | head -n 20

  echo -e "\n✅ Network & security checks completed."
}

# === HEADER ===
log "📋 VPS System Info:"
echo "🖥️  Hostname: $(hostname)"
echo "📦 OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)"
echo "💽 Disk Space:"
df -h /

# === UPDATE SYSTEM ===
log "🔧 Updating system packages..."
(sudo apt update && sudo apt upgrade -y) & spin

# === INSTALL REQUIRED TOOLS ===
log "📦 Installing ClamAV, chkrootkit, lynis, etc..."
(sudo apt install -y clamav chkrootkit lynis wget conntrack ufw fail2ban) & spin

# === CLAMAV ===
log "🔁 Updating ClamAV signatures..."
(sudo systemctl stop clamav-freshclam || true && sudo freshclam) & spin

# === INSTALL MALDET ===
if ! command -v maldet &>/dev/null; then
  log "📥 Installing Maldet..."
  (
    cd /usr/local/src/ &&
    wget http://www.rfxn.com/downloads/maldetect-current.tar.gz &&
    tar -xzf maldetect-current.tar.gz &&
    cd maldetect-* &&
    sudo ./install.sh
  ) & spin
fi

# === SCANS ===
log "🔍 Starting Malware and Rootkit Scans..."

log "🧪 ClamAV scan..."
(clamscan -r --infected --no-summary \
  --exclude-dir="^/proc" \
  --exclude-dir="^/sys" \
  --exclude-dir="^/dev" / > clamav_scan.log) & spin
log "✅ ClamAV scan complete."

log "🧪 chkrootkit scan..."
(sudo chkrootkit > chkrootkit_scan.log) & spin
log "✅ chkrootkit scan complete."

log "🧪 Lynis audit..."
(sudo lynis audit system > lynis_scan.log) & spin
log "✅ Lynis audit complete."

log "🧪 Maldet scan..."
(sudo maldet -a / > maldet_scan.log) & spin
log "✅ Maldet scan complete."

# === NETWORK & SECURITY CHECK ===
log "🔐 Running network & security checks..."
check_network_security > network_security.log 2>&1
log "✅ Network & security checks complete."

# === REPORT ===
timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
report_file="vps_audit_report_$timestamp.log"

{
echo "=== VPS Daily Security Report ==="
echo "📆 Date: $(date)"
echo "📋 Hostname: $(hostname)"
echo "📦 OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)"
echo "💽 Disk usage:"
df -h /
echo

echo "🔍 ClamAV Infected Files:"
grep "FOUND" clamav_scan.log || echo "None found."
echo

echo "🔍 chkrootkit Suspicious Results:"
grep -v "not infected" chkrootkit_scan.log || echo "No suspicious output."
echo

echo "🔍 Lynis Warnings/Suggestions:"
grep -E "Warning|Suggestion" lynis_scan.log || echo "No major issues."
echo

echo "🔍 Maldet Infections:"
grep "infected" maldet_scan.log || echo "None detected."
echo

echo "🔍 Network & Security Checks (see network_security.log for details):"
head -n 30 network_security.log
echo "..."

} > "$report_file"

log "📄 Report saved as $report_file"
