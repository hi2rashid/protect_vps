#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

# === SPINNER ===
spin() {
  local pid=$!
  local delay=0.1
  local spinstr='|/-\'
  while kill -0 "$pid" 2>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  wait $pid
}

log() {
  echo -e "\n[$(date +"%H:%M:%S")] $1"
}

# === HEADER ===
log "ğŸ“‹ VPS System Info:"
echo "ğŸ–¥ï¸  Hostname: $(hostname)"
echo "ğŸ“¦ OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)"
echo "ğŸ’½ Disk Space:"
df -h /

# === UPDATE SYSTEM ===
log "ğŸ”§ Updating system packages..."
(sudo apt update && sudo apt upgrade -y) & spin

# === INSTALL REQUIRED TOOLS ===
log "ğŸ“¦ Installing ClamAV, chkrootkit, rkhunter, lynis..."
(sudo apt install -y clamav chkrootkit rkhunter lynis wget) & spin

# === CLAMAV ===
log "ğŸ” Updating ClamAV signatures..."
(sudo systemctl stop clamav-freshclam || true && sudo freshclam) & spin

# === RKHUNTER FIX ===
log "âš™ï¸ Configuring rkhunter..."
sudo sed -i 's/^UPDATE_MIRRORS=.*/UPDATE_MIRRORS=1/' /etc/rkhunter.conf || true
sudo sed -i 's/^MIRRORS_MODE=.*/MIRRORS_MODE=0/' /etc/rkhunter.conf || true
sudo sed -i 's|^WEB_CMD=.*|WEB_CMD=/bin/false|' /etc/rkhunter.conf || true

log "ğŸ“¦ Updating rkhunter..."
(sudo rkhunter --update --verbose || echo "âš ï¸ rkhunter update failed") & spin

# === INSTALL MALDET ===
if ! command -v maldet &>/dev/null; then
  log "ğŸ“¥ Installing Maldet..."
  (
    cd /usr/local/src/ &&
    wget http://www.rfxn.com/downloads/maldetect-current.tar.gz &&
    tar -xzf maldetect-current.tar.gz &&
    cd maldetect-* &&
    sudo ./install.sh
  ) & spin
fi

# === SCANS ===
log "ğŸ” Starting Malware and Rootkit Scans..."

log "ğŸ§ª ClamAV scan..."
(clamscan -r --infected --no-summary \
  --exclude-dir="^/proc" \
  --exclude-dir="^/sys" \
  --exclude-dir="^/dev" / > clamav_scan.log) & spin
log "âœ… ClamAV scan complete."

log "ğŸ§ª chkrootkit scan..."
(sudo chkrootkit > chkrootkit_scan.log) & spin
log "âœ… chkrootkit scan complete."

log "ğŸ§ª rkhunter scan..."
(sudo rkhunter --check --skip-keypress > rkhunter_scan.log) & spin
log "âœ… rkhunter scan complete."

log "ğŸ§ª Lynis audit..."
(sudo lynis audit system > lynis_scan.log) & spin
log "âœ… Lynis audit complete."

log "ğŸ§ª Maldet scan..."
(sudo maldet -a / > maldet_scan.log) & spin
log "âœ… Maldet scan complete."

# === REPORT ===
timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
report_file="vps_audit_report_$timestamp.log"

echo "=== VPS Daily Security Report ===" > "$report_file"
echo "ğŸ“† Date: $(date)" >> "$report_file"
echo "ğŸ“‹ Hostname: $(hostname)" >> "$report_file"
echo "ğŸ“¦ OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)" >> "$report_file"
echo "ğŸ’½ Disk usage:" >> "$report_file"
df -h / >> "$report_file"

echo -e "\nğŸ” ClamAV Infected Files:" >> "$report_file"
grep "FOUND" clamav_scan.log >> "$report_file" || echo "None found." >> "$report_file"

echo -e "\nğŸ” chkrootkit Suspicious Results:" >> "$report_file"
grep -v "not infected" chkrootkit_scan.log >> "$report_file" || echo "No suspicious output." >> "$report_file"

echo -e "\nğŸ” rkhunter Warnings:" >> "$report_file"
grep "Warning:" rkhunter_scan.log >> "$report_file" || echo "No warnings." >> "$report_file"

echo -e "\nğŸ” Lynis Warnings/Suggestions:" >> "$report_file"
grep -E "Warning|Suggestion" lynis_scan.log >> "$report_file" || echo "No major issues." >> "$report_file"

echo -e "\nğŸ” Maldet Infections:" >> "$report_file"
grep "infected" maldet_scan.log >> "$report_file" || echo "None detected." >> "$report_file"

echo -e "\nâœ… End of report. Check .log files for full output." >> "$report_file"

log "ğŸ“„ Report saved as $report_file"
