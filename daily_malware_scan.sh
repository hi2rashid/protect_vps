#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

# === SPINNER ===
spin() {
  local pid=$!
  local delay=0.1
  local spinstr='|/-\'
  while kill -0 "$pid" 2>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  wait $pid
}

log() {
  echo -e "\n[$(date +"%H:%M:%S")] $1"
}

# === HEADER ===
log "📋 VPS System Info:"
echo "🖥️  Hostname: $(hostname)"
echo "📦 OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)"
echo "💽 Disk Space:"
df -h /

# === UPDATE SYSTEM ===
log "🔧 Updating system packages..."
(sudo apt update && sudo apt upgrade -y) & spin

# === INSTALL REQUIRED TOOLS ===
log "📦 Installing ClamAV, chkrootkit, rkhunter, lynis..."
(sudo apt install -y clamav chkrootkit rkhunter lynis wget) & spin

# === CLAMAV ===
log "🔁 Updating ClamAV signatures..."
(sudo systemctl stop clamav-freshclam || true && sudo freshclam) & spin

# === RKHUNTER FIX ===
log "⚙️ Configuring rkhunter..."
sudo sed -i 's/^UPDATE_MIRRORS=.*/UPDATE_MIRRORS=1/' /etc/rkhunter.conf || true
sudo sed -i 's/^MIRRORS_MODE=.*/MIRRORS_MODE=0/' /etc/rkhunter.conf || true
sudo sed -i 's|^WEB_CMD=.*|WEB_CMD=/bin/false|' /etc/rkhunter.conf || true

log "📦 Updating rkhunter..."
(sudo rkhunter --update --verbose || echo "⚠️ rkhunter update failed") & spin

# === INSTALL MALDET ===
if ! command -v maldet &>/dev/null; then
  log "📥 Installing Maldet..."
  (
    cd /usr/local/src/ &&
    wget http://www.rfxn.com/downloads/maldetect-current.tar.gz &&
    tar -xzf maldetect-current.tar.gz &&
    cd maldetect-* &&
    sudo ./install.sh
  ) & spin
fi

# === SCANS ===
log "🔍 Starting Malware and Rootkit Scans..."

log "🧪 ClamAV scan..."
(clamscan -r --infected --no-summary \
  --exclude-dir="^/proc" \
  --exclude-dir="^/sys" \
  --exclude-dir="^/dev" / > clamav_scan.log) & spin
log "✅ ClamAV scan complete."

log "🧪 chkrootkit scan..."
(sudo chkrootkit > chkrootkit_scan.log) & spin
log "✅ chkrootkit scan complete."

log "🧪 rkhunter scan..."
(sudo rkhunter --check --skip-keypress > rkhunter_scan.log) & spin
log "✅ rkhunter scan complete."

log "🧪 Lynis audit..."
(sudo lynis audit system > lynis_scan.log) & spin
log "✅ Lynis audit complete."

log "🧪 Maldet scan..."
(sudo maldet -a / > maldet_scan.log) & spin
log "✅ Maldet scan complete."

# === REPORT ===
timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
report_file="vps_audit_report_$timestamp.log"

echo "=== VPS Daily Security Report ===" > "$report_file"
echo "📆 Date: $(date)" >> "$report_file"
echo "📋 Hostname: $(hostname)" >> "$report_file"
echo "📦 OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)" >> "$report_file"
echo "💽 Disk usage:" >> "$report_file"
df -h / >> "$report_file"

echo -e "\n🔍 ClamAV Infected Files:" >> "$report_file"
grep "FOUND" clamav_scan.log >> "$report_file" || echo "None found." >> "$report_file"

echo -e "\n🔍 chkrootkit Suspicious Results:" >> "$report_file"
grep -v "not infected" chkrootkit_scan.log >> "$report_file" || echo "No suspicious output." >> "$report_file"

echo -e "\n🔍 rkhunter Warnings:" >> "$report_file"
grep "Warning:" rkhunter_scan.log >> "$report_file" || echo "No warnings." >> "$report_file"

echo -e "\n🔍 Lynis Warnings/Suggestions:" >> "$report_file"
grep -E "Warning|Suggestion" lynis_scan.log >> "$report_file" || echo "No major issues." >> "$report_file"

echo -e "\n🔍 Maldet Infections:" >> "$report_file"
grep "infected" maldet_scan.log >> "$report_file" || echo "None detected." >> "$report_file"

echo -e "\n✅ End of report. Check .log files for full output." >> "$report_file"

log "📄 Report saved as $report_file"
