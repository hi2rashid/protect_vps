#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

# === SPINNER ===
spin() {
  local pid=$!
  local delay=0.1
  local spinstr='|/-\'
  while kill -0 "$pid" 2>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  wait $pid
}

log() {
  echo -e "\n[$(date +"%H:%M:%S")] $1"
}

# === NETWORK & SECURITY CHECK FUNCTION ===
check_network_security() {
  echo -e "\nğŸ” Starting network & security checks..."

  echo -e "\n1ï¸âƒ£ Active network connections (ss):"
  sudo ss -tupn | head -n 20

  echo -e "\n2ï¸âƒ£ Suspicious port scanner processes:"
  pscan=$(ps aux | grep -Ei 'nmap|masscan|scan|portscan|zmap' | grep -v grep || true)
  if [[ -z "$pscan" ]]; then
    echo "âœ… No common port scanner processes detected."
  else
    echo "âš ï¸ Possible port scanner processes found:"
    echo "$pscan"
  fi

  echo -e "\n3ï¸âƒ£ Fail2Ban SSH ban status (if fail2ban installed):"
  if command -v fail2ban-client &>/dev/null; then
    sudo fail2ban-client status sshd || echo "No SSH jail found."
  else
    echo "âš ï¸ fail2ban not installed."
  fi

  echo -e "\n4ï¸âƒ£ Recent SSH login attempts (last 20 lines):"
  sudo tail -n 20 /var/log/auth.log | grep -i ssh || echo "No recent ssh logins found or log missing."

  echo -e "\n5ï¸âƒ£ Current UFW firewall status:"
  if command -v ufw &>/dev/null; then
    sudo ufw status verbose
  else
    echo "âš ï¸ UFW firewall not installed."
  fi

  echo -e "\n6ï¸âƒ£ Top remote IPs by current connections:"
  if command -v conntrack &>/dev/null; then
    sudo conntrack -L 2>/dev/null | awk '{print $5}' | sort | uniq -c | sort -nr | head -n 10
  else
    echo "âš ï¸ conntrack not installed."
  fi

  echo -e "\n7ï¸âƒ£ Listening ports summary:"
  sudo ss -tuln | head -n 20

  echo -e "\nâœ… Network & security checks completed."
}

# === HEADER ===
log "ğŸ“‹ VPS System Info:"
echo "ğŸ–¥ï¸  Hostname: $(hostname)"
echo "ğŸ“¦ OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)"
echo "ğŸ’½ Disk Space:"
df -h /

# === UPDATE SYSTEM ===
log "ğŸ”§ Updating system packages..."
(sudo apt update && sudo apt upgrade -y) & spin

# === INSTALL REQUIRED TOOLS ===
log "ğŸ“¦ Installing ClamAV, chkrootkit, lynis, etc..."
(sudo apt install -y clamav chkrootkit lynis wget conntrack ufw fail2ban) & spin

# === CLAMAV ===
log "ğŸ” Updating ClamAV signatures..."
(sudo systemctl stop clamav-freshclam || true && sudo freshclam) & spin

# === INSTALL MALDET ===
if ! command -v maldet &>/dev/null; then
  log "ğŸ“¥ Installing Maldet..."
  (
    cd /usr/local/src/ &&
    wget http://www.rfxn.com/downloads/maldetect-current.tar.gz &&
    tar -xzf maldetect-current.tar.gz &&
    cd maldetect-* &&
    sudo ./install.sh
  ) & spin
fi

# === SCANS ===
log "ğŸ” Starting Malware and Rootkit Scans..."

log "ğŸ§ª ClamAV scan..."
(clamscan -r --infected --no-summary \
  --exclude-dir="^/proc" \
  --exclude-dir="^/sys" \
  --exclude-dir="^/dev" / > clamav_scan.log) & spin
log "âœ… ClamAV scan complete."

log "ğŸ§ª chkrootkit scan..."
(sudo chkrootkit > chkrootkit_scan.log) & spin
log "âœ… chkrootkit scan complete."

log "ğŸ§ª Lynis audit..."
(sudo lynis audit system > lynis_scan.log) & spin
log "âœ… Lynis audit complete."

log "ğŸ§ª Maldet scan..."
(sudo maldet -a / > maldet_scan.log) & spin
log "âœ… Maldet scan complete."

# === NETWORK & SECURITY CHECK ===
log "ğŸ” Running network & security checks..."
check_network_security > network_security.log 2>&1
log "âœ… Network & security checks complete."

# === REPORT ===
timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
report_file="vps_audit_report_$timestamp.log"

{
echo "=== VPS Daily Security Report ==="
echo "ğŸ“† Date: $(date)"
echo "ğŸ“‹ Hostname: $(hostname)"
echo "ğŸ“¦ OS: $(lsb_release -ds || grep PRETTY_NAME /etc/os-release | cut -d= -f2)"
echo "ğŸ’½ Disk usage:"
df -h /
echo

echo "ğŸ” ClamAV Infected Files:"
grep "FOUND" clamav_scan.log || echo "None found."
echo

echo "ğŸ” chkrootkit Suspicious Results:"
grep -v "not infected" chkrootkit_scan.log || echo "No suspicious output."
echo

echo "ğŸ” Lynis Warnings/Suggestions:"
grep -E "Warning|Suggestion" lynis_scan.log || echo "No major issues."
echo

echo "ğŸ” Maldet Infections:"
grep "infected" maldet_scan.log || echo "None detected."
echo

echo "ğŸ” Network & Security Checks (see network_security.log for details):"
head -n 30 network_security.log
echo "..."

} > "$report_file"

log "ğŸ“„ Report saved as $report_file"
